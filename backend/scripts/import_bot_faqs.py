#!/usr/bin/env python
"""
ホームページからのQ&AをBotFAQにインポートするスクリプト
Usage: python manage.py shell < scripts/import_bot_faqs.py
"""
import os
import sys
import django

# Django setup
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.local')
django.setup()

from apps.communications.models import BotConfig, BotFAQ
from apps.tenants.models import Tenant

def get_or_create_bot_config(tenant_id):
    """ボット設定を取得または作成"""
    bot_config, created = BotConfig.objects.get_or_create(
        tenant_id=tenant_id,
        is_active=True,
        defaults={
            'name': 'AIアシスタント',
            'welcome_message': 'こんにちは！何かお手伝いできることはありますか？\n\n授業のこと、予約のこと、料金のことなど、何でもお気軽にお聞きください。',
            'fallback_message': '申し訳ありませんが、その質問にはお答えできません。スタッフにお問い合わせください。',
            'bot_type': 'GENERAL',
            'ai_enabled': False,
        }
    )
    if created:
        print(f"Created new BotConfig: {bot_config.name}")
    else:
        print(f"Using existing BotConfig: {bot_config.name}")
    return bot_config

# FAQデータ（ホームページから取得）
FAQ_DATA = [
    # ===== 共通・全般 =====
    {
        'category': '全般',
        'question': 'アンイングリッシュグループとは何ですか？',
        'answer': 'アンイングリッシュGROUPは、名古屋・尾張旭を中心に、愛知・岐阜で80教室以上を展開する総合教育グループです。英会話、そろばん、習字、プログラミング、学習塾など様々な教育サービスを提供しています。',
        'keywords': ['アン', 'グループ', '会社', '何', 'どんな'],
    },
    {
        'category': '全般',
        'question': '教室はどこにありますか？',
        'answer': '愛知県・岐阜県を中心に80教室以上を展開しています。ホームページの「教室を探す」から、お近くの教室を検索できます。学年と目的（英会話、そろばん等）から絞り込み検索も可能です。',
        'keywords': ['教室', '場所', 'どこ', '近く', '住所', 'アクセス', '検索'],
    },
    {
        'category': '全般',
        'question': '対象年齢は何歳からですか？',
        'answer': '1歳から高校生まで、様々なコースをご用意しています。\n・インターナショナルスクール：1歳〜\n・英会話・そろばん・習字：年少〜\n・プログラミング：小1〜高校生\n・学習塾：小1〜高校生',
        'keywords': ['年齢', '何歳', '対象', '幼児', '小学生', '中学生'],
    },
    {
        'category': '全般',
        'question': '無料体験はできますか？',
        'answer': 'はい、全てのコースで無料体験授業を実施しています。「らくらくマイページ」からWEBでお申し込みいただけます。',
        'keywords': ['体験', '無料', '見学', '試し'],
    },
    {
        'category': '全般',
        'question': '割引制度はありますか？',
        'answer': 'はい、様々な割引をご用意しています。\n・家族割引：兄弟姉妹でご受講の場合\n・フレンドシップ割引：お友達紹介\n・複数科目割引：複数コース同時受講の場合\n詳しくはスタッフにお問い合わせください。',
        'keywords': ['割引', '安く', 'お得', '家族', '兄弟', '紹介'],
    },
    {
        'category': '全般',
        'question': '振替はできますか？',
        'answer': '「らくらくマイページ」からWEB上で欠席登録と振替予約ができます。50教室以上の直営教室で振替が可能です。',
        'keywords': ['振替', '欠席', '休み', 'キャンセル', '変更', '都合'],
    },
    {
        'category': '全般',
        'question': '英検対策はありますか？',
        'answer': 'はい、アン進学ジムでは追加費用なしで英検対策講座を提供しています。単独での受講も可能です。',
        'keywords': ['英検', '検定', '資格', '対策'],
    },
    {
        'category': '全般',
        'question': '冬期講習はありますか？',
        'answer': 'はい、冬期講習会を開催しています。詳しい日程・内容はホームページまたはスタッフにお問い合わせください。',
        'keywords': ['冬期', '講習', '夏期', '春期', '季節'],
    },

    # ===== アンイングリッシュクラブ =====
    {
        'category': 'アンイングリッシュクラブ',
        'question': 'いつでも入会できますか？',
        'answer': 'はい、いつでも入会可能です。まずはWEBから体験授業をお申し込みください。',
        'keywords': ['入会', '入学', 'いつ', '申込', '申し込み'],
    },
    {
        'category': 'アンイングリッシュクラブ',
        'question': 'リレーティーチングとペアティーチングの違いは？',
        'answer': 'リレーティーチングは日本人講師と外国人講師が週ごとに交代で指導します。ペアティーチングは毎週両方の講師が一緒に指導します。目標や予算に合わせてお選びください。',
        'keywords': ['リレー', 'ペア', 'ティーチング', '講師', '指導'],
    },
    {
        'category': 'アンイングリッシュクラブ',
        'question': '授業料はいくらですか？',
        'answer': '授業料はクラスレベルや指導方法により、月額1,000円〜7,500円と異なります。詳しくは料金表をご確認ください。',
        'keywords': ['授業料', '料金', '月謝', 'いくら', '費用', '価格'],
    },
    {
        'category': 'アンイングリッシュクラブ',
        'question': '振替はできますか？',
        'answer': '「らくらくマイページ」からWEB上で欠席登録と振替予約ができます。50教室以上の直営教室で振替が可能です。',
        'keywords': ['振替', '欠席', '休み', 'キャンセル', '変更'],
    },
    {
        'category': 'アンイングリッシュクラブ',
        'question': '割引はありますか？',
        'answer': 'はい。「家族割引」や「フレンドシップ割引」など、様々な割引をご用意しています。',
        'keywords': ['割引', '安く', 'お得', '家族', 'フレンドシップ'],
    },
    {
        'category': 'アンイングリッシュクラブ',
        'question': '「5年で英語が話せる」とはどういう意味ですか？',
        'answer': '翻訳なしで英語を理解する力を養い、徐々にスピーキング能力を構築し、生徒が自然に英語で自分を表現できるようになることを目指しています。',
        'keywords': ['5年', '話せる', '英語力', '目標'],
    },

    # アンそろばんクラブ
    {
        'category': 'アンそろばんクラブ',
        'question': 'クラスの定員は何名ですか？',
        'answer': '教室ごとに異なります。詳しくはお問い合わせください。',
        'keywords': ['定員', '人数', 'クラス', '何名'],
    },
    {
        'category': 'アンそろばんクラブ',
        'question': '左利きの場合はどうなりますか？',
        'answer': '左利きでも「左手」で筆記、「右手」で計算するよう指導します。そろばんは利き手に関係なく上達できます。',
        'keywords': ['左利き', '利き手'],
    },
    {
        'category': 'アンそろばんクラブ',
        'question': '他のそろばん教室との併学は可能ですか？',
        'answer': '入会は可能ですが、指導法の違いで実力に影響する恐れがあります。なお、準3級以上・有段者の方は入会をお受けしておりません。',
        'keywords': ['併学', '他の教室', '掛け持ち'],
    },
    {
        'category': 'アンそろばんクラブ',
        'question': '検定試験は毎月受験必須ですか？',
        'answer': 'いいえ、毎月の受験は必須ではありません。講師が習得状況に応じて受験時期をご案内します。',
        'keywords': ['検定', '試験', '受験', '毎月'],
    },

    # アン美文字クラブ
    {
        'category': 'アン美文字クラブ',
        'question': '無料体験授業とはどのようなものですか？',
        'answer': '通常授業に参加していただきます。お習字道具は教室備えつけのものをお貸し出しします。',
        'keywords': ['体験', '無料', '見学'],
    },
    {
        'category': 'アン美文字クラブ',
        'question': '宿題はありますか？',
        'answer': 'ありません。授業内で完結します。',
        'keywords': ['宿題', '課題', '家庭学習'],
    },
    {
        'category': 'アン美文字クラブ',
        'question': '授業時間は何分ですか？',
        'answer': '美文字キッズは30分、習字の筆っこは50分です。時間内で終われるようしっかりカリキュラムが組まれています。',
        'keywords': ['時間', '何分', '長さ', '授業時間'],
    },

    # アンプログラミングクラブ
    {
        'category': 'アンプログラミングクラブ',
        'question': 'プログラミング教室に通うとどういったキャリアが考えられますか？',
        'answer': 'すべての生徒がIT関連に進学・就職するわけではありませんが、プログラミング的思考は論理的思考につながり、自分らしく道を切り開ける力が身につきます。高校進学時に専門的な道を選ぶ生徒もいます。',
        'keywords': ['キャリア', '将来', '進路', 'IT', '就職'],
    },
    {
        'category': 'アンプログラミングクラブ',
        'question': '対象年齢は何歳からですか？',
        'answer': '基本的には小学1年生〜高校生が対象です。2024年4月より年長さんも受講可能になりました。',
        'keywords': ['対象', '年齢', '何歳', '小学生', '幼児'],
    },
    {
        'category': 'アンプログラミングクラブ',
        'question': 'パソコンが初めてでも大丈夫ですか？',
        'answer': 'マウス操作を含む基本操作からカリキュラムを構成しているため、パソコン初心者でも安心して受講できます。',
        'keywords': ['初心者', 'パソコン', '初めて', 'PC'],
    },
    {
        'category': 'アンプログラミングクラブ',
        'question': 'プログラミングは全く分かりませんが大丈夫ですか？',
        'answer': '全員初歩から始めるため初心者でも安心です。個別進度学習なので、ゆっくり進めることも、先に進むことも柔軟に対応できます。',
        'keywords': ['分からない', '初心者', '未経験', '初歩'],
    },

    # ===== アン進学ジム =====
    {
        'category': 'アン進学ジム',
        'question': 'アン進学ジムの対象学年は？',
        'answer': '小学1年〜6年の小学部と、中学1年〜3年の中学部があります。',
        'keywords': ['進学ジム', '学年', '対象', '小学', '中学'],
    },
    {
        'category': 'アン進学ジム',
        'question': 'アン進学ジムの授業料は？',
        'answer': '【中学部】\n・1Day フリー：中1 ¥7,800/中2 ¥8,800/中3 ¥10,000\n・2Days フリー：中1 ¥14,000/中2 ¥16,000/中3 ¥18,000\n・All フリー：中1 ¥18,000/中2 ¥20,000/中3 ¥25,000\n\n【小学部】\n・週1コマ：¥5,800\n・週2コマ：¥7,800\n・週3コマ：¥9,800\n・フリー：¥13,000\n※税抜き。別途月会費・教材費が必要です。',
        'keywords': ['進学ジム', '授業料', '料金', '月謝', '費用'],
    },
    {
        'category': 'アン進学ジム',
        'question': 'バイキング方式とは何ですか？',
        'answer': 'アン進学ジム中学部の特徴で、教室開講日なら何度でも通塾できる定額制システムです。自分のペースで学習量を調整できます。',
        'keywords': ['バイキング', '通い放題', '定額', '何度でも'],
    },
    {
        'category': 'アン進学ジム',
        'question': '宿題はありますか？（進学ジム）',
        'answer': 'テストに向けた個々の定着状況や進度、通塾コマ数によって宿題は異なります。担当講師が適切な量を設定します。',
        'keywords': ['宿題', '課題', '進学ジム'],
    },

    # ===== アンインターナショナルスクール =====
    {
        'category': 'アンインターナショナルスクール',
        'question': 'インターナショナルスクールは何歳から？',
        'answer': '満1歳からご入園いただけます。\n・ラビット：満1歳〜1歳半\n・ペンギン：満1歳半〜\n・バンビ：2歳\n・ゼブラ〜エレファント：年少〜年長\n・アフター：年少〜小2',
        'keywords': ['インターナショナル', '保育', '幼稚園', '何歳', '入園'],
    },
    {
        'category': 'アンインターナショナルスクール',
        'question': 'インターナショナルスクールの料金は？',
        'answer': '月額料金の目安です。\n・ラビット（1歳〜）：¥30,000〜\n・ペンギン（1歳半〜）：¥28,000〜\n・バンビ（2歳）：¥20,000〜\n・ゼブラ〜エレファント：¥17,000〜\n・アフター：¥15,000〜\n※非課税。詳細はお問い合わせください。',
        'keywords': ['インターナショナル', '料金', '月謝', '保育料'],
    },
    {
        'category': 'アンインターナショナルスクール',
        'question': 'インターナショナルスクールは認可施設ですか？',
        'answer': '無認可施設です。独自の教育理想を実現するため、あえて認可を取得していません。ただし、保育無償化の対象施設として認定されています。',
        'keywords': ['認可', '無認可', '保育無償化'],
    },
    {
        'category': 'アンインターナショナルスクール',
        'question': 'インターナショナルスクールの営業時間は？',
        'answer': 'レギュラークラス：9:30〜15:00\nアフタークラス：15:30〜19:00\n週1〜5回の通園回数を選択できます。',
        'keywords': ['営業時間', '何時', '開園', '預かり'],
    },

    # ===== アンまなびワールド =====
    {
        'category': 'アンまなびワールド',
        'question': 'アンまなびワールドとは？',
        'answer': 'アンまなびワールドは、小学生を対象とした定額制学習サービスです。進学ジム、英会話、そろばん、プログラミング、将棋、習字、読書、英検対策など12の学習コースを同一施設で受講できます。',
        'keywords': ['まなび', 'ワールド', '学童', '定額'],
    },
    {
        'category': 'アンまなびワールド',
        'question': 'まなびワールドは何コマまで受講できますか？',
        'answer': '開講日内であれば上限はありません。6コマ以上受講されるなら「アンまなびワールド」の料金がお得になります。',
        'keywords': ['コマ', '上限', '何回', 'まなび'],
    },
    {
        'category': 'アンまなびワールド',
        'question': 'まなびワールドの兄弟割引はありますか？',
        'answer': 'はい、ご兄弟・姉妹で「アンまなびワールド」をご受講いただいた場合に割引が適用されます。',
        'keywords': ['兄弟', '割引', 'まなび', '姉妹'],
    },

    # ===== お問い合わせ・サポート =====
    {
        'category': 'サポート',
        'question': '体験授業を受けたいのですが',
        'answer': '体験授業は「らくらくマイページ」からWEBでお申し込みいただけます。ご希望の教室・日時をお選びください。ご不明な点があればお気軽にお問い合わせください。',
        'keywords': ['体験', '見学', '試し', '申込'],
    },
    {
        'category': 'サポート',
        'question': '資料請求したい',
        'answer': 'ホームページの「資料請求」からお申し込みいただけます。ご希望のコースの詳しいパンフレットをお送りします。',
        'keywords': ['資料', 'パンフレット', '請求', '送って'],
    },
    {
        'category': 'サポート',
        'question': '退会したいのですが',
        'answer': '退会のお手続きは「らくらくマイページ」または教室スタッフにご連絡ください。退会届の提出が必要となります。',
        'keywords': ['退会', 'やめたい', '辞めたい', '解約'],
    },
    {
        'category': 'サポート',
        'question': 'コースを変更したい',
        'answer': 'コース変更のご相談は教室スタッフまでお申し付けください。お子様の状況に合わせて最適なコースをご提案します。',
        'keywords': ['変更', 'コース', '切り替え', '移動'],
    },
    {
        'category': 'サポート',
        'question': '支払い方法は？',
        'answer': '口座振替でのお支払いとなります。毎月の授業料は指定口座から自動引き落としされます。',
        'keywords': ['支払い', '引き落とし', '口座', '振替', '料金'],
    },
    {
        'category': 'サポート',
        'question': 'スタッフと直接話したい',
        'answer': '承知しました。スタッフにおつなぎします。少々お待ちください。',
        'keywords': ['スタッフ', '相談', '話したい', '人間', '担当者', '電話'],
        'next_action': 'transfer_to_staff',
    },
]

def import_faqs():
    """FAQをインポート"""
    # テナントを取得
    tenant = Tenant.objects.first()
    if not tenant:
        print("Error: No tenant found")
        return

    print(f"Using tenant: {tenant.tenant_name} ({tenant.id})")

    # ボット設定を取得または作成
    bot_config = get_or_create_bot_config(tenant.id)

    # 既存のFAQを削除（オプション）
    # BotFAQ.objects.filter(bot_config=bot_config).delete()

    # FAQをインポート
    created_count = 0
    updated_count = 0

    for i, faq_data in enumerate(FAQ_DATA):
        faq, created = BotFAQ.objects.update_or_create(
            tenant_id=tenant.id,
            bot_config=bot_config,
            question=faq_data['question'],
            defaults={
                'category': faq_data.get('category', ''),
                'answer': faq_data['answer'],
                'keywords': faq_data.get('keywords', []),
                'next_action': faq_data.get('next_action'),
                'sort_order': i,
                'is_active': True,
            }
        )
        if created:
            created_count += 1
            print(f"  Created: {faq_data['question'][:30]}...")
        else:
            updated_count += 1
            print(f"  Updated: {faq_data['question'][:30]}...")

    print(f"\nImport complete: {created_count} created, {updated_count} updated")
    print(f"Total FAQs: {BotFAQ.objects.filter(bot_config=bot_config).count()}")

if __name__ == '__main__':
    import_faqs()
